<!doctype html><html lang=ja><head><title>Velocity 2015, Linux Performance Tools, Brendan Gregg: 方法論 · /etc/openjny
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Junya Yamaguchi (@openjny)"><meta name=description content="Gregg 先生が 2015 年の Velocity Conference で公演した &ldquo;Linux Performance Tools, Brendan Gregg&rdquo; を YouTube で見つけたので、今日ははじめのトラブルシューティングの方法論についてまとめました。

  公演について
  
    
    見出しへのリンク
  
"><meta name=keywords content="blog,azure,cloud computing,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Velocity 2015, Linux Performance Tools, Brendan Gregg: 方法論"><meta name=twitter:description content="Gregg 先生が 2015 年の Velocity Conference で公演した “Linux Performance Tools, Brendan Gregg” を YouTube で見つけたので、今日ははじめのトラブルシューティングの方法論についてまとめました。
公演について 見出しへのリンク"><meta property="og:url" content="https://openjny.github.io/posts/2020/06/21/velocity-2015-linux-perf-tools-methodologies/"><meta property="og:site_name" content="/etc/openjny"><meta property="og:title" content="Velocity 2015, Linux Performance Tools, Brendan Gregg: 方法論"><meta property="og:description" content="Gregg 先生が 2015 年の Velocity Conference で公演した “Linux Performance Tools, Brendan Gregg” を YouTube で見つけたので、今日ははじめのトラブルシューティングの方法論についてまとめました。
公演について 見出しへのリンク"><meta property="og:locale" content="ja"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-06-21T00:00:00+00:00"><meta property="article:modified_time" content="2020-06-21T00:00:00+00:00"><meta property="article:tag" content="Brendan Gregg"><meta property="article:tag" content="Linux"><meta property="article:tag" content="パフォーマンス チューニング"><link rel=canonical href=https://openjny.github.io/posts/2020/06/21/velocity-2015-linux-perf-tools-methodologies/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.140953f60ced76bc313e5d112c66fd4eb9df859f9cbc71a559db3d781dadcc70.css integrity="sha256-FAlT9gztdrwxPl0RLGb9TrnfhZ+cvHGlWds9eB2tzHA=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://openjny.github.io/>/etc/openjny
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>ブログ</a></li><li class=navigation-item><a class=navigation-link href=/tags/>タグ</a></li><li class=navigation-item><a class=navigation-link href=/categories/>カテゴリ</a></li><li class=navigation-item><a class=navigation-link href=/projects/>プロジェクト</a></li><li class=navigation-item><a class=navigation-link href=/about-me/>About Me</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=/en/>🇺🇸</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://openjny.github.io/posts/2020/06/21/velocity-2015-linux-perf-tools-methodologies/>Velocity 2015, Linux Performance Tools, Brendan Gregg: 方法論</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2020-06-21T00:00:00Z>2020年6月21日
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
5分で読めます</span></div><div class=categories><i class="fa-solid fa-folder" aria-hidden=true></i>
<a href=/categories/linux/>Linux</a></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/brendan-gregg/>Brendan Gregg</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/linux/>Linux</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9-%E3%83%81%E3%83%A5%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0/>パフォーマンス チューニング</a></span></div></div></header><div class=post-content><p>Gregg 先生が 2015 年の Velocity Conference で公演した &ldquo;Linux Performance Tools, Brendan Gregg&rdquo; を YouTube で見つけたので、今日ははじめのトラブルシューティングの方法論についてまとめました。</p><h2 id=公演について>公演について
<a class=heading-link href=#%e5%85%ac%e6%bc%94%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><ul><li><a href="https://www.youtube.com/watch?v=FJW8nGV4jxY" class=external-link target=_blank rel=noopener>Linux Performance Tools, Brendan Gregg, part 1 of 2 - YouTube</a></li><li><a href="https://www.youtube.com/watch?v=zrr2nUln9Kk" class=external-link target=_blank rel=noopener>Linux Performance Tools, Brendan Gregg, part 2 of 2 - YouTube</a></li></ul><blockquote><p>Tutorial by Brendan Gregg of Netflix for O&rsquo;Reilly Velocity conference 2015 Santa Clara.</p></blockquote><p>スライドは次のページから見れます。</p><ul><li><a href=https://www.slideshare.net/brendangregg/velocity-2015-linux-perf-tools class=external-link target=_blank rel=noopener>Velocity 2015 linux perf tools</a></li></ul><h2 id=アンチパターン>アンチパターン
<a class=heading-link href=#%e3%82%a2%e3%83%b3%e3%83%81%e3%83%91%e3%82%bf%e3%83%bc%e3%83%b3><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><p>まずはじめにトラブルシューティングのアンチパターンを紹介していました。</p><h3 id=street-light-anti-method>Street Light Anti-Method
<a class=heading-link href=#street-light-anti-method><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h3><figure><img src=2020-06-21-velocity-2015-linux-perf-tools-methodologies/streetlight-anti-method.png></figure><ul><li>財布を落とした場所のうち、探しやすい電灯付近しか探さない男の風刺画</li><li>パフォーマンスが悪化した時、多くの人は状況を診断するための観測ツール (observability tools) を使うが、使いやすいものやインターネットでたまたま見かけたものしか使わない</li><li>スコーピングを意識しない診断では真の原因はわからないことが多い</li></ul><h3 id=drunk-man-anti-method>Drunk Man Anti-Method
<a class=heading-link href=#drunk-man-anti-method><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h3><ul><li>手当り次第調整できるパラメータをランダムに変更していって、治るまで続ける方法</li><li>自分の考える Cons<ul><li>治った理由を説明できない</li><li>もっと問題を悪くするリスクがある</li><li>次のトラブルシューティングに活かすことが出来ない</li></ul></li></ul><h3 id=blame-someone-else-anti-method>Blame Someone Else Anti-Method
<a class=heading-link href=#blame-someone-else-anti-method><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h3><p>よくあるたらい回しの手続き</p><ol><li>自分が責任をおっていないコンポーネントをひとつ見つける</li><li>そのコンポーネントが原因であると仮説をたてる</li><li>コンポーネントを担当するチームに調査依頼する</li><li>もし仮説が間違っていたら手順 1 に戻る</li></ol><h2 id=方法論-methodorogies>方法論 (methodorogies)
<a class=heading-link href=#%e6%96%b9%e6%b3%95%e8%ab%96-methodorogies><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><p>方法論を説明する前に、Gregg 先生は <code>./lab002</code> の名前のユーザー プログラムを実行して、聴衆にトラシューするよう促していました。<code>vmstat</code> や <code>top</code> などの様々な実行結果を見てみたいという意見がありましたが、結局おかしなところは見つからず、最後に面白い結末でデモは終了します。実は <code>./lab002</code> は何も実行していなかったのです。</p><p>この例は方法論の重要性を如実に表しています。つまり、やみくみに実行するトラブル シューティングが役に立たないということです。</p><p>自分にとってもこれは非常に面白いデモだったので印象に残っています。以下では、発表で紹介があったいくつかの方法論をまとめますが、Gregg 先生の本をみると他にも様々な方法論を体系立てているようなので、そちらも時間があるときに見てみたいですね。</p><h3 id=problem-statement-method>Problem Statement Method
<a class=heading-link href=#problem-statement-method><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h3><p>これは問題のスタートポイントを定めるための方法論。Gregg がサン・マイクロシステムズのサポートをしていた間、チケット起票時に必ず確認していた事項らしい。</p><ol><li>パフォーマンス問題が発生していると<strong>考えた</strong>きっかけとなったものは何か?</li><li><strong>これまで</strong>問題なくシステムが動いていた実績があるか?</li><li>最近何か<strong>変わった</strong>ものはないか? (e.g. ソフトウェア、ハードウェア、負荷)</li><li>パフォーマンス問題は<strong>レイテンシ</strong>や実行時間の観点で表現できるか?</li><li>その問題は<strong>他の</strong>人やアプリケーションに影響を与えているか?</li><li><strong>環境</strong>は何か? (e.g. ソフトウェア、ハードウェア、インスタンスタイプ、バージョン、構成情報)</li></ol><h3 id=workload-characterizaton-method>Workload Characterizaton Method
<a class=heading-link href=#workload-characterizaton-method><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h3><p>ワークロードを定量化して把握するため、4 つの情報を収集する方法論。これで大体の問題は解決するらしい。</p><ul><li><strong>Who</strong>: 誰が負荷を与えているか (e.g. PID, UDI, IP Address)</li><li><strong>Why</strong>: なぜ負荷を与える処理が実行されているか (e.g. code path, stack trace)</li><li><strong>What</strong>: 負荷は何か (e.g. IPOS, tput, type, r/w)</li><li><strong>How</strong>: 時間が経過すると負荷はどうなっていくか</li></ul><h3 id=use-method>USE Method
<a class=heading-link href=#use-method><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h3><p>各リソース (CPU, ディスク、メモリ、etc) で 3 つのメトリックをチェックすれば答えが導かれるという方法論。</p><ul><li><strong>Utilizaton</strong>: リソースがサービスを提供するのに平均してどれくらい時間がかかったか</li><li><strong>Saturation</strong>: 提供できない余剰のタスクがリソースにどれくらいあったか (典型的にはキューの長さ)</li><li><strong>Errors</strong>: エラーイベントの数</li></ul><p>逆に言えば、これら以外のメトリックは見なくても良いという安心感をあたえる。これについて、Gregg 氏は「暗黙的な未知 (unknown-unknowns) が 明示的な未知 (known-unknwons) となる」という表現をしている。</p><p>例えば、ネットワークのコンポーネント (NIC) で USE Method を適用すると、以下のようになる。</p><ul><li>U: 送信/受信におけるパケットのバイト数</li><li>S: 送信/受信におけるペンディング パケット数</li><li>E: ポリシー以外の理由でドロップされたパケット数</li></ul><p>Kubernetes で実際に USE Method を適用してみたという記事があるので、参考になると思う。また、本家の USE Method の解説には推奨される解釈方法などの詳細が記載されている。</p><ul><li><a href=https://blog.freshtracks.io/a-deep-dive-into-kubernetes-metrics-part-2-c869581e9f29 class=external-link target=_blank rel=noopener>A Deep Dive into Kubernetes Metrics — Part 2 - FreshTracks.io</a></li><li><a href=http://www.brendangregg.com/usemethod.html class=external-link target=_blank rel=noopener>The USE Method</a></li></ul><h3 id=off-cpu-analysis>Off-CPU Analysis
<a class=heading-link href=#off-cpu-analysis><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h3><figure><img src=2020-06-21-velocity-2015-linux-perf-tools-methodologies/off-cpu-analysis.png></figure><p>USE Method を使えば、沢山のデバイスレベルの問題 (e.g. ネットワーク インターフェイスがビジー状態) を容易に発見できるが、一方でロック競合のような複雑に条件が絡みあっている問題を発見することは出来ない。この時役立つのが Off-CPU Analysis。</p><p>Off-CPU Anaysis の観点では、パフォーマンス問題は以下の 2 種類に大別できる。</p><ul><li>On-CPU: スレッドが CPU 上で実行されている時の問題</li><li>Off-CPU: I/O、ロック、タイマ、ページング (スワッピング) のような待ちが発生している時の問題。簡単に言えば <code>time</code> コマンドの <code>{real} - ({user} + {sys})</code> が長い時の話。</li></ul><p>Off-CPU Analysis は Off-CPU のパフォーマンス問題を分析する方法論で、実行状態から外れた I/O 待ち、Block、Idle 状態のスレッドを調査する為に用いられる。</p><p>Linux だと eBPF 等のトレーサーで調査が出来るらしいが詳細はわからない。本人の公式ページを見るのが良い。</p><ul><li><a href=http://www.brendangregg.com/offcpuanalysis.html class=external-link target=_blank rel=noopener>Off-CPU Analysis</a></li></ul><h3 id=cpu-profile-method>CPU Profile Method
<a class=heading-link href=#cpu-profile-method><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h3><figure><img src=2020-06-21-velocity-2015-linux-perf-tools-methodologies/flame-graph.png></figure><ul><li>プロファイラで CPU profile を取得する</li><li>実行時間が全体のうち 1 %以上のすべてのソフトウェアを理解するのがよい (が、難しい・・・)</li></ul><p>Flame Graph と呼ばれる CPU プロファイルを可視化するツールを使って効率的に分析できる。</p><ul><li><a href=http://www.brendangregg.com/flamegraphs.html class=external-link target=_blank rel=noopener>Flame Graphs</a></li><li><a href=https://qiita.com/saikoro-steak/items/bf066241eeef1141ef5f class=external-link target=_blank rel=noopener>perf使ってみた - Qiita</a></li><li><a href=https://yohei-a.hatenablog.jp/entry/20150706/1436208007 class=external-link target=_blank rel=noopener>perf + Flame Graphs で Linux カーネル内のボトルネックを特定する - ablog</a></li></ul><h3 id=rtfm-method>RTFM Method
<a class=heading-link href=#rtfm-method><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h3><p>パフォーマンス ツールやメトリック等の道具そのものの理解を目的とした方法論。特にソースコードを読んで、実験してみる方法が効果的とのこと。</p><ul><li>Linux の man ページ</li><li>書籍</li><li>ウェブ検索</li><li>同僚</li><li>技術トーク、スライド</li><li>サポート サービス</li><li>ソースコード</li><li>実験</li></ul><h2 id=参考文献>参考文献
<a class=heading-link href=#%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><ul><li><a href="https://www.youtube.com/watch?v=FJW8nGV4jxY" class=external-link target=_blank rel=noopener>Linux Performance Tools, Brendan Gregg, part 1 of 2 - YouTube</a></li><li><a href="https://www.youtube.com/watch?v=zrr2nUln9Kk" class=external-link target=_blank rel=noopener>Linux Performance Tools, Brendan Gregg, part 2 of 2 - YouTube</a></li><li><a href=http://www.brendangregg.com/overview.html class=external-link target=_blank rel=noopener>Brendan Gregg: Overview</a></li></ul></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2024
Junya Yamaguchi (@openjny)
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "0a99e4ebb1e342beb03db419a6eea4a6"}'></script></body></html>