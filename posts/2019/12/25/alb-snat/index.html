<!doctype html><html lang=ja><head><title>Azure Load Balancer の SNAT がさっぱりわからん · /etc/openjny
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Junya Yamaguchi (@openjny)"><meta name=description content="この記事では、Azure Load Balancer の配下にある VM から、インターネットと通信したい時の話を取りあげます。
具体的には、いわゆる SNAT と呼ばれる仕組みで、Outbound 通信ができるパターンが LB の構成に依存していくつか存在するので、それを紹介します。

  背景
  
    
    見出しへのリンク
  
"><meta name=keywords content="blog,azure,cloud computing,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Azure Load Balancer の SNAT がさっぱりわからん"><meta name=twitter:description content="この記事では、Azure Load Balancer の配下にある VM から、インターネットと通信したい時の話を取りあげます。 具体的には、いわゆる SNAT と呼ばれる仕組みで、Outbound 通信ができるパターンが LB の構成に依存していくつか存在するので、それを紹介します。
背景 見出しへのリンク"><meta property="og:url" content="https://openjny.github.io/posts/2019/12/25/alb-snat/"><meta property="og:site_name" content="/etc/openjny"><meta property="og:title" content="Azure Load Balancer の SNAT がさっぱりわからん"><meta property="og:description" content="この記事では、Azure Load Balancer の配下にある VM から、インターネットと通信したい時の話を取りあげます。 具体的には、いわゆる SNAT と呼ばれる仕組みで、Outbound 通信ができるパターンが LB の構成に依存していくつか存在するので、それを紹介します。
背景 見出しへのリンク"><meta property="og:locale" content="ja"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-12-25T00:00:00+00:00"><meta property="article:modified_time" content="2019-12-25T00:00:00+00:00"><meta property="article:tag" content="Azure"><meta property="article:tag" content="Networking"><meta property="article:tag" content="Load Balancer"><meta property="article:tag" content="SNAT"><link rel=canonical href=https://openjny.github.io/posts/2019/12/25/alb-snat/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.140953f60ced76bc313e5d112c66fd4eb9df859f9cbc71a559db3d781dadcc70.css integrity="sha256-FAlT9gztdrwxPl0RLGb9TrnfhZ+cvHGlWds9eB2tzHA=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://openjny.github.io/>/etc/openjny
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>ブログ</a></li><li class=navigation-item><a class=navigation-link href=/tags/>タグ</a></li><li class=navigation-item><a class=navigation-link href=/categories/>カテゴリ</a></li><li class=navigation-item><a class=navigation-link href=/projects/>プロジェクト</a></li><li class=navigation-item><a class=navigation-link href=/about-me/>About Me</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=/en/>🇺🇸</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://openjny.github.io/posts/2019/12/25/alb-snat/>Azure Load Balancer の SNAT がさっぱりわからん</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2019-12-25T00:00:00Z>2019年12月25日
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
6分で読めます</span></div><div class=categories><i class="fa-solid fa-folder" aria-hidden=true></i>
<a href=/categories/azure/>Azure</a></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/azure/>Azure</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/networking/>Networking</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/load-balancer/>Load Balancer</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/snat/>SNAT</a></span></div></div></header><div class=post-content><p>この記事では、Azure Load Balancer の配下にある VM から、インターネットと通信したい時の話を取りあげます。
具体的には、いわゆる SNAT と呼ばれる仕組みで、Outbound 通信ができるパターンが LB の構成に依存していくつか存在するので、それを紹介します。</p><h2 id=背景>背景
<a class=heading-link href=#%e8%83%8c%e6%99%af><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><p>実の所このドキュメントに全部書いてあります。・・・・ただ、長い・・・<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>。</p><div class="notice info"><div class=notice-title><i class="fa-solid fa-exclamation-circle" aria-hidden=true></i>Info</div><div class=notice-content><strong>Azure の Outbound connections - Azure Load Balancer | Microsoft Docs</strong>
<a href=https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections class=external-link target=_blank rel=noopener>https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections</a></div></div><p>本稿は、上の内容を「<strong>概要をぱっと速く掴みたい人</strong>」向けにざっくりまとめたものです。</p><h3 id=おさらい>おさらい
<a class=heading-link href=#%e3%81%8a%e3%81%95%e3%82%89%e3%81%84><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h3><p>本筋の前に、簡単に LB と VM の関係や、LB の SKU について確認しておきます。</p><ul><li>Load Balancer には <strong>内部/パブリック</strong> という種類がある<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>。<ul><li><strong>パブリック ロードバランサー (Public Load Balancer)</strong> は、すべてのフロントエンドが「パブリック IP アドレスのグローバル IP アドレス」で構成されている LB のことです。歴史的経緯から「外部 LB」と呼ぶこともあり、名称が短いという単純な理由で本稿では「外部 LB」と呼ぶことにします。</li><li><strong>内部ロードバランサー (Internal Load Balancer; ILB)</strong> は、すべてのフロントエンドが「仮想ネットワーク内のプライベート IP アドレス」で構成されている LB のこと。</li></ul></li><li>Load Balancer の SKU には <strong>Basic/Standard</strong> がある<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>。<ul><li>種類とは独立した概念です</li><li>例) Basic SKU の内部 LB、Basic SKU の外部 LB</li></ul></li><li>VM は次のいずれかのパターンで LB に組み込める<ul><li>一つの内部 LB にだけ所属</li><li>一つの外部 LB にだけ所属</li><li>一つの内部 LB と一つの外部 LB の両方に所属 ※この時、両 LB の SKU が揃っている必要があります<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>。</li></ul></li></ul><h2 id=1-パブリック-ip-アドレスがある-vm-の場合>1. パブリック IP アドレスがある VM の場合
<a class=heading-link href=#1-%e3%83%91%e3%83%96%e3%83%aa%e3%83%83%e3%82%af-ip-%e3%82%a2%e3%83%89%e3%83%ac%e3%82%b9%e3%81%8c%e3%81%82%e3%82%8b-vm-%e3%81%ae%e5%a0%b4%e5%90%88><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><figure><img src=https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/127839/312074e5-7463-aa1a-1a7f-859ca7cb529f.png alt=image.png><figcaption><p>image.png</p></figcaption></figure><p><strong>VM に関連付けられたパブリック IP アドレス (PIP) が存在する場合、LB の構成に関わらず、必ず PIP を利用して SNAT します。</strong></p><p><a href=https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections class=external-link target=_blank rel=noopener>上記ドキュメント</a>では<a href=https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#ilpip class=external-link target=_blank rel=noopener>「シナリオ 1」</a>に該当する構成パターンです。</p><p>以下で登場する他の構成パターンと異なり、<strong>パブリック IP のすべてのエフェメラル ポートを使用できる</strong>というメリットがあります。
ただ、デメリットとして PIP による金銭的コストの増加や、ファイアウォールの管理コストの増加等の影響があるので注意してください。</p><p>参考: <a href=https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#assignilpip class=external-link target=_blank rel=noopener>各 VM にパブリック IP を割り当てる | Microsoft Docs</a></p><h2 id=2-パブリック-ip-アドレスがない-vm-の場合>2. パブリック IP アドレスがない VM の場合
<a class=heading-link href=#2-%e3%83%91%e3%83%96%e3%83%aa%e3%83%83%e3%82%af-ip-%e3%82%a2%e3%83%89%e3%83%ac%e3%82%b9%e3%81%8c%e3%81%aa%e3%81%84-vm-%e3%81%ae%e5%a0%b4%e5%90%88><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><figure><img src=https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/127839/10498ab8-a4d0-67f9-db06-d595e105fd35.png alt=image.png><figcaption><p>image.png</p></figcaption></figure><p>パターンは 4 つですね。</p><ul><li>Azure 既定の SNAT</li><li>送信不可</li><li>外部 LB の SNAT</li><li>外部 LB の SNAT + 送信規則</li></ul><h3 id=azure-既定の-snat>Azure 既定の SNAT
<a class=heading-link href=#azure-%e6%97%a2%e5%ae%9a%e3%81%ae-snat><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h3><p><a href=https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#defaultsnat class=external-link target=_blank rel=noopener>上記ドキュメントの「シナリオ 3」</a>に相当する状況。
VM のデプロイされた <strong>Azure リージョンで使われる &ldquo;任意のグローバル IP アドレス&rdquo;<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup> を利用して SNAT</strong> されます。</p><p>Download Azure IP Ranges and Service Tags – Public Cloud from Official Microsoft Download Center
<a href="https://www.microsoft.com/en-us/download/details.aspx?id=56519" class=external-link target=_blank rel=noopener>https://www.microsoft.com/en-us/download/details.aspx?id=56519</a></p><p>注意事項としては、<strong>送信フロー毎に利用される IP アドレスが変わる</strong>こと。
例えばファイアウォールなどでホワイトリストしたり、サーバー側でクライアントの IP アドレスを利用するシナリオ等で注意が必要です。</p><h3 id=送信不可>送信不可
<a class=heading-link href=#%e9%80%81%e4%bf%a1%e4%b8%8d%e5%8f%af><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h3><p>(パブリック IP アドレスもなく、外部 LB の配下にもいない VM が) <strong>Standard SKU の内部 LB の配下にいる場合は、外部と通信できません</strong><sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup>。</p><h3 id=外部-lb-の-snat>外部 LB の SNAT
<a class=heading-link href=#%e5%a4%96%e9%83%a8-lb-%e3%81%ae-snat><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h3><p><a href=https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#lb class=external-link target=_blank rel=noopener>上記ドキュメントの「シナリオ 2」</a>に相当する状況。</p><p><strong>外部 Load Balancer のフロントエンドに付与したパブリック IP アドレスを利用して SNAT される</strong>。そのため、SNAT で利用する IP アドレスが (一般に複数ではあるものの) 固定されているのが特徴。</p><p>このシナリオには、結構引っかかりやすい落とし穴がいくつかあるので要注意。</p><h4 id=注意-1-負荷分散規則を作って初めて-snat-出来るようになる>注意 1: 負荷分散規則を作って初めて SNAT 出来るようになる
<a class=heading-link href=#%e6%b3%a8%e6%84%8f-1-%e8%b2%a0%e8%8d%b7%e5%88%86%e6%95%a3%e8%a6%8f%e5%89%87%e3%82%92%e4%bd%9c%e3%81%a3%e3%81%a6%e5%88%9d%e3%82%81%e3%81%a6-snat-%e5%87%ba%e6%9d%a5%e3%82%8b%e3%82%88%e3%81%86%e3%81%ab%e3%81%aa%e3%82%8b><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h4><p>Basic SKU の場合、TCP/UDP のどちらの負荷分散規則でも良いので、SNAT したい ipconfig に対する負荷分散規則を作成している必要がある。</p><p>■ Azure の Outbound connections - Azure Load Balancer | Microsoft Docs
<a href=https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#preallocatedports class=external-link target=_blank rel=noopener>https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#preallocatedports</a></p><blockquote><p>Basic SKU の SNAT では、負荷分散規則で指定されたトランスポート プロトコルに関係なく、常に両方の IP トランスポート プロトコルに対して SNAT がプログラムされます。</p></blockquote><h4 id=注意-2-ipconfig-ごとに任意のエフェメラル-ポートが使える訳ではない>注意 2: ipconfig ごとに任意のエフェメラル ポートが使える訳ではない
<a class=heading-link href=#%e6%b3%a8%e6%84%8f-2-ipconfig-%e3%81%94%e3%81%a8%e3%81%ab%e4%bb%bb%e6%84%8f%e3%81%ae%e3%82%a8%e3%83%95%e3%82%a7%e3%83%a1%e3%83%a9%e3%83%ab-%e3%83%9d%e3%83%bc%e3%83%88%e3%81%8c%e4%bd%bf%e3%81%88%e3%82%8b%e8%a8%b3%e3%81%a7%e3%81%af%e3%81%aa%e3%81%84><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h4><p>以下の公式ドキュメントに定義されているように、ipconfig ごとが利用できる SNAT ポート数 (i.e. 同時に張れる Outbound TCP コネクション数) は予め決まっている。</p><p>■ Azure の Outbound connections - Azure Load Balancer | Microsoft Docs
<a href=https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#preallocatedports class=external-link target=_blank rel=noopener>https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#preallocatedports</a></p><blockquote><p>次の表は、バックエンド プール サイズのレベルに対する SNAT ポートの事前割り当てを示しています。
(表略)</p></blockquote><h3 id=外部-lb-の-snat--送信規則>外部 LB の SNAT + 送信規則
<a class=heading-link href=#%e5%a4%96%e9%83%a8-lb-%e3%81%ae-snat--%e9%80%81%e4%bf%a1%e8%a6%8f%e5%89%87><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h3><p>これも<a href=https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#lb class=external-link target=_blank rel=noopener>ドキュメントの「シナリオ 2」</a>に相当する状況で、基本は「外部 LB の SNAT」と同じだけど、<strong>さらに送信規則によって SNAT をコントロール出来る</strong>パターン。</p><p>&ldquo;基本は&rdquo; と述べたのは、<strong>「外部 LB の SNAT」とは 注意 1 についての仕様が少し違う</strong>から。具体的には次の通り。</p><ul><li>負荷分散規則を構成して初めて SNAT 出来る点は、Basic も Standard も変わらない</li><li>Standard SKU の場合は、TCP の SNAT なら TCP の負荷分散規則が、UDP の SNAT なら UDP の負荷分散規則が、といった風に<strong>プロトコル毎の規則作成が必要</strong>となる。</li></ul><p>■ Azure の Outbound connections - Azure Load Balancer | Microsoft Docs
<a href=https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#preallocatedports class=external-link target=_blank rel=noopener>https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#preallocatedports</a></p><blockquote><p>重要
Standard SKU の SNAT プログラミングは、IP トランスポート プロトコルに従い、負荷分散規則から派生します。 TCP 負荷分散規則だけが存在する場合、SNAT は TCP でのみ使用できます。 TCP 負荷分散規則しかないときに、UDP の送信 SNAT が必要な場合は、同じフロントエンドから同じバックエンド プールへの UDP 負荷分散規則を作成します。 これにより、UDP の SNAT プログラミングがトリガーされます。 動作規則や正常性プローブは不要です。</p></blockquote><h4 id=送信規則>送信規則
<a class=heading-link href=#%e9%80%81%e4%bf%a1%e8%a6%8f%e5%89%87><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h4><p>この構成パターンの最大の特徴は、<strong>送信規則 (outbound rule)</strong> と呼ばれる、Standard 外部 LB 特有の機能が利用できること。
送信規則は、<strong>Basic SKU での [注意 2] の制限を緩和する</strong>目的で利用され、その概要や構成方法については以下の公式ドキュメントで詳細に記述されている。</p><p>■ アウトバウンド規則 - Azure Load Balancer | Microsoft Docs
<a href=https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-rules-overview class=external-link target=_blank rel=noopener>https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-rules-overview</a></p><h2 id=まとめ>まとめ
<a class=heading-link href=#%e3%81%be%e3%81%a8%e3%82%81><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>細かいところを網羅しなければならないという、ドキュメントに課せられた要請上、仕方がない点です。&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-overview#load-balancer-types class=external-link target=_blank rel=noopener>Azure Load Balancer の概要 - Azure Load Balancer | Microsoft Docs</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-standard-overview#what-is-standard-load-balancer class=external-link target=_blank rel=noopener>Azure Standard Load Balancer とは - Azure Load Balancer | Microsoft Docs</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://blogs.technet.microsoft.com/jpaztech/2019/01/29/azurelb-tips/#cannot-add-vm class=external-link target=_blank rel=noopener>Azure ロードバランサー利用時の注意点 – Japan Azure IaaS Support Blog</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p>なお、グローバル IP アドレスの一覧は、以下のページからダウンロード出来ます。&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p><a href=https://blogs.technet.microsoft.com/jpaztech/2019/01/29/azurelb-tips/#outbound-cannot-connect class=external-link target=_blank rel=noopener>Azure ロードバランサー利用時の注意点 – Japan Azure IaaS Support Blog</a>&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2024 -
2025
Junya Yamaguchi (@openjny)
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "0a99e4ebb1e342beb03db419a6eea4a6"}'></script></body></html>