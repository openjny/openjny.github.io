<!doctype html><html lang=ja><head><title>[bpf-perf-workshop] lab1: ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·èª¿æŸ» Â· /etc/openjny
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Junya Yamaguchi (@openjny)"><meta name=description content="Brendan Gregg æ°ã®ãƒãƒ³ã‚ºã‚ªãƒ³ ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ— &ldquo;bpf-perf-workshop&rdquo; ã‚ˆã‚Šã€æœ€åˆã®èª²é¡Œ (ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã®èª¿æŸ»èª²é¡Œ) &ldquo;lab2&rdquo; ã‚’ã‚„ã£ã¦ã¿ã¾ã—ãŸã€‚

  èª²é¡Œ
  
    
    è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯
  
"><meta name=keywords content="blog,azure,cloud computing,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="[bpf-perf-workshop] lab1: ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·èª¿æŸ»"><meta name=twitter:description content="Brendan Gregg æ°ã®ãƒãƒ³ã‚ºã‚ªãƒ³ ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ— â€œbpf-perf-workshopâ€ ã‚ˆã‚Šã€æœ€åˆã®èª²é¡Œ (ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã®èª¿æŸ»èª²é¡Œ) â€œlab2â€ ã‚’ã‚„ã£ã¦ã¿ã¾ã—ãŸã€‚
èª²é¡Œ è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯"><meta property="og:url" content="https://openjny.github.io/posts/2021/05/11/bpf-perf-workshop-lab1/"><meta property="og:site_name" content="/etc/openjny"><meta property="og:title" content="[bpf-perf-workshop] lab1: ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·èª¿æŸ»"><meta property="og:description" content="Brendan Gregg æ°ã®ãƒãƒ³ã‚ºã‚ªãƒ³ ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ— â€œbpf-perf-workshopâ€ ã‚ˆã‚Šã€æœ€åˆã®èª²é¡Œ (ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã®èª¿æŸ»èª²é¡Œ) â€œlab2â€ ã‚’ã‚„ã£ã¦ã¿ã¾ã—ãŸã€‚
èª²é¡Œ è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯"><meta property="og:locale" content="ja"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-11T00:00:00+00:00"><meta property="article:modified_time" content="2021-05-11T00:00:00+00:00"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Brendan Gregg"><meta property="article:tag" content="ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°"><meta property="article:tag" content="eBPF"><meta property="article:tag" content="Bcc"><link rel=canonical href=https://openjny.github.io/posts/2021/05/11/bpf-perf-workshop-lab1/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.140953f60ced76bc313e5d112c66fd4eb9df859f9cbc71a559db3d781dadcc70.css integrity="sha256-FAlT9gztdrwxPl0RLGb9TrnfhZ+cvHGlWds9eB2tzHA=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://openjny.github.io/>/etc/openjny
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>ãƒ–ãƒ­ã‚°</a></li><li class=navigation-item><a class=navigation-link href=/tags/>ã‚¿ã‚°</a></li><li class=navigation-item><a class=navigation-link href=/categories/>ã‚«ãƒ†ã‚´ãƒª</a></li><li class=navigation-item><a class=navigation-link href=/projects/>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</a></li><li class=navigation-item><a class=navigation-link href=/about-me/>About Me</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=/en/>ğŸ‡ºğŸ‡¸</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://openjny.github.io/posts/2021/05/11/bpf-perf-workshop-lab1/>[bpf-perf-workshop] lab1: ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·èª¿æŸ»</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2021-05-11T00:00:00Z>2021å¹´5æœˆ11æ—¥
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
10åˆ†ã§èª­ã‚ã¾ã™</span></div><div class=categories><i class="fa-solid fa-folder" aria-hidden=true></i>
<a href=/categories/linux/>Linux</a></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/linux/>Linux</a>
</span><span class=separator>â€¢</span>
<span class=tag><a href=/tags/brendan-gregg/>Brendan Gregg</a>
</span><span class=separator>â€¢</span>
<span class=tag><a href=/tags/%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%83%81%E3%83%A5%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0/>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°</a>
</span><span class=separator>â€¢</span>
<span class=tag><a href=/tags/ebpf/>eBPF</a>
</span><span class=separator>â€¢</span>
<span class=tag><a href=/tags/bcc/>Bcc</a></span></div></div></header><div class=post-content><p>Brendan Gregg æ°ã®ãƒãƒ³ã‚ºã‚ªãƒ³ ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ— &ldquo;bpf-perf-workshop&rdquo; ã‚ˆã‚Šã€æœ€åˆã®èª²é¡Œ (ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã®èª¿æŸ»èª²é¡Œ) &ldquo;lab2&rdquo; ã‚’ã‚„ã£ã¦ã¿ã¾ã—ãŸã€‚</p><h2 id=èª²é¡Œ>èª²é¡Œ
<a class=heading-link href=#%e8%aa%b2%e9%a1%8c><i class="fa-solid fa-link" aria-hidden=true title=è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯></i>
<span class=sr-only>è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯</span></a></h2><p>ä»Šå›ã®å•é¡Œã¯ã“ã¡ã‚‰ã€‚</p><p><a href=https://github.com/brendangregg/bpf-perf-workshop/blob/master/lab1.md class=external-link target=_blank rel=noopener>bpf-perf-workshop/lab1.md at master Â· brendangregg/bpf-perf-workshop</a></p><blockquote><p>Problem Statement
An application has higher-than expected latency, including latency outliers. Why, and how can performance be improved?</p></blockquote><p>æ€ã£ãŸã‚ˆã†ã«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒå‡ºãªã„ (i.e. å®Ÿè¡Œãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒå¤§ãã„) ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ <code>./lab001</code> ã«å¯¾ã—ã¦ã€ãã®ç†ç”±ã¨æ”¹å–„æ–¹æ³•ã‚’èª¿æŸ»ã—ã‚ã€ã¨ã„ã†èª²é¡Œã€‚</p><h2 id=60ç§’åˆ†æ>60ç§’åˆ†æ
<a class=heading-link href=#60%e7%a7%92%e5%88%86%e6%9e%90><i class="fa-solid fa-link" aria-hidden=true title=è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯></i>
<span class=sr-only>è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯</span></a></h2><p>ã¾ãšã¯ã€æœ‰åãª 60 ç§’åˆ†æã§ CPUã€Memoryã€FileSystem/Disksã€Network ã®ã„ãšã‚ŒãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã«ãªã£ã¦ã„ã‚‹ã‹ãƒ•ã‚£ãƒ¼ãƒªãƒ³ã‚°ã‚’æ´ã‚€ã€‚</p><p><a href=https://netflixtechblog.com/linux-performance-analysis-in-60-000-milliseconds-accc10403c55 class=external-link target=_blank rel=noopener>Linux Performance Analysis in 60,000 Milliseconds | by Netflix Technology Blog | Netflix TechBlog</a></p><pre tabindex=0><code>root@vm-ubuntu:~# uptime
 12:31:53 up 30 min,  3 users,  load average: 1.99, 1.37, 0.65
</code></pre><p><code>lab001</code> ã‚’å®Ÿè¡Œã—ãŸå¾Œã® <code>uptime</code> ã®çµæœãŒä¸Šã€‚å¾ŒåŠ 3 ã¤ã®å€¤ã¯ã€ãã‚Œãã‚Œç›´è¿‘ 1, 5, 15 åˆ†ã§ã® load average (ç§»å‹•æŒ‡æ•°å¹³å‡) ã‚’è¡¨ã—ã¦ã„ã‚‹ã€‚</p><p>Linux ã§ã® load average ã¯ã€TASK_RUNNING + TASK_UNINTERRUPTIBLE çŠ¶æ…‹ãªã‚¿ã‚¹ã‚¯æ•°ã®ç·å’Œã‚’è¡¨ã—ã¦ã‚‹ã“ã¨ã«æ³¨æ„ã™ã‚Œã°ã€<code>lab001</code> ã‚’å®Ÿè¡Œã—ãŸã“ã¨ã§ã“ã‚Œã‚‰ã‚¿ã‚¹ã‚¯ã®æ•°ãŒå¢—ãˆã¦ãã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚‹ã€‚</p><pre tabindex=0><code>root@vm-ubuntu:~# dmesg | tail
[   13.055942] audit: type=1400 audit(1620907273.224:11): apparmor=&#34;STATUS&#34; operation=&#34;profile_load&#34; profile=&#34;unconfined&#34; name=&#34;/usr/lib/snapd/snap-confine&#34; pid=841 comm=&#34;apparmor_parser&#34;
[   18.327127] IPv6: ADDRCONF(NETDEV_CHANGE): eth0: link becomes ready
[   23.839985]  sda: sda1
[   26.123281] EXT4-fs (sda1): mounted filesystem with ordered data mode. Opts: (null)
[   26.588156] new mount options do not match the existing superblock, will be ignored
[   57.834818] hv_balloon: Max. dynamic memory size: 16384 MB
[  109.372614] SGI XFS with ACLs, security attributes, realtime, no debug enabled
[  109.466644] JFS: nTxBlock = 8192, nTxLock = 65536
[  109.531712] ntfs: driver 2.1.32 [Flags: R/O MODULE].
[  109.685490] QNX4 filesystem 0.2.3 registered.
</code></pre><p><code>dmesg -T</code> ã¨ã‹è¦‹ã¦ã¿ã‚‹ã¨ã‚ˆãåˆ†ã‹ã‚‹ã‘ã©ã€<code>lab001</code> ã‚’èµ·å‹•ã—ã¦ã‹ã‚‰ã¯ç‰¹ã«ç•°å¸¸ãŒç™ºç”Ÿã—ãŸæ§˜å­ã¯ãªã„ã€‚</p><pre tabindex=0><code>root@vm-ubuntu:~# vmstat -S M 1
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  1      0  14846     88    786    0    0    77   342   56  187  1  0 96  3  0
 0  1      0  14846     88    786    0    0     0  1696  556 1637  0  0 97  2  0
 0  1      0  14846     88    786    0    0     0  3712  372 1641  0  0 80 19  0
 0  1      0  14846     88    786    0    0     0  1776  355 1681  0  0 76 24  0
 0  1      0  14846     88    786    0    0     0  3788  540 1747  0  1 93  6  0
</code></pre><ul><li>UNINTERRUPTIBLE_SLEEP çŠ¶æ…‹ãªã‚¿ã‚¹ã‚¯ãŒå¸¸ã« 1 ã¤ã‚ã‚‹</li><li>User (us), System (sy) æ™‚é–“ã¨ã‚‚ã«ã»ã¨ã‚“ã©æ¶ˆè²»ã—ã¦ã„ãªã„</li><li>I/O å¾…ã¡ (wa) æ™‚é–“ãŒæ¯”è¼ƒçš„å¤šã„ (24 %ã‚’å ã‚ã‚‹ã¨ãã‚‚ã‚ã‚‹)</li><li>Swap In/Out ã¯ã‚¼ãƒ­ã§å•é¡Œãªã—</li><li>ç©ºããƒ¡ãƒ¢ãƒªã‚‚ä½™è£•ãŒã‚ã‚‹</li></ul><p>ä»¥ä¸Šã®ç‚¹ã‹ã‚‰ã€CPU ã‚„ãƒ¡ãƒ¢ãƒªã§ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã§ã¯ãªãã€I/O ã§ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯èª¬ãŒç–‘ã‚ã‚Œã‚‹ã€‚</p><pre tabindex=0><code>root@vm-ubuntu:~# mpstat -P ALL 1
Linux 5.4.0-1047-azure (vm-ubuntu)      05/13/21        _x86_64_        (4 CPU)

12:43:52     CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
12:43:53     all    0.25    0.00    0.50   13.07    0.00    0.00    0.00    0.00    0.00   86.18
12:43:53       0    0.00    0.00    0.00   51.52    0.00    0.00    0.00    0.00    0.00   48.48
12:43:53       1    0.00    0.00    1.00    2.00    0.00    0.00    0.00    0.00    0.00   97.00
12:43:53       2    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
12:43:53       3    0.00    0.00    1.01    0.00    0.00    0.00    0.00    0.00    0.00   98.99

12:43:53     CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
12:43:54     all    0.25    0.00    1.00    2.99    0.00    0.00    0.00    0.00    0.00   95.76
12:43:54       0    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
12:43:54       1    1.00    0.00    0.00    3.00    0.00    0.00    0.00    0.00    0.00   96.00
12:43:54       2    0.00    0.00    1.98    7.92    0.00    0.00    0.00    0.00    0.00   90.10
12:43:54       3    0.00    0.00    1.00    0.00    0.00    0.00    0.00    0.00    0.00   99.00

12:43:54     CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
12:43:55     all    0.00    0.00    0.50    1.50    0.00    0.00    0.00    0.00    0.00   97.99
12:43:55       0    0.00    0.00    0.00    0.00    0.00    1.00    0.00    0.00    0.00   99.00
12:43:55       1    0.00    0.00    1.00    3.00    0.00    0.00    0.00    0.00    0.00   96.00
12:43:55       2    0.00    0.00    1.00    4.00    0.00    0.00    0.00    0.00    0.00   95.00
12:43:55       3    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
</code></pre><p>è«–ç† CPU ã”ã¨ã«è² è·ãŒã°ã‚‰ã‘ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªãã€CPU#0 ã§ I/O Wait ãŒç™ºç”Ÿã™ã‚‹ã‚¿ã‚¹ã‚¯ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹æ¨¡æ§˜ã€‚</p><pre tabindex=0><code>root@vm-ubuntu:~# pidstat 1
Linux 5.4.0-1047-azure (vm-ubuntu)      05/13/21        _x86_64_        (4 CPU)

12:45:12      UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
12:45:13        0        11    0.99    0.00    0.00    0.00    0.99     3  rcu_sched
12:45:13        0       380    0.00    1.98    0.00    0.00    1.98     2  jbd2/sdb1-8
12:45:13        0      5689    0.00    0.99    0.00    0.00    0.99     1  lab001
12:45:13        0      7009    0.99    0.00    0.00    0.00    0.99     3  pidstat

12:45:13      UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
12:45:14        0       380    0.00    1.00    0.00    0.00    1.00     2  jbd2/sdb1-8
12:45:14        0      5689    0.00    1.00    0.00    0.00    1.00     1  lab001
12:45:14        0      7009    0.00    1.00    0.00    0.00    1.00     3  pidstat

12:45:14      UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
12:45:15        0       380    0.00    2.00    0.00    1.00    2.00     2  jbd2/sdb1-8
12:45:15        0      5689    0.00    1.00    0.00    0.00    1.00     1  lab001
</code></pre><p>pidstat ãŒè¡¨ç¤ºã™ã‚‹ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã¯ã€å…¨ CPU ã®ç·å’Œã§ã‚ã‚‹ç‚¹ã«æ³¨æ„ã€‚ã‚ã¾ã‚Šæœ‰ç›Šãªæƒ…å ±ã¯å¾—ã‚‰ã‚Œã¦ã„ãªã„ã€‚</p><pre tabindex=0><code>root@vm-ubuntu:~# iostat -xz 1

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.25    0.00    0.00    1.76    0.00   97.99

Device            r/s     w/s     rkB/s     wkB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util
sdb              0.00  325.00      0.00   1748.00     0.00   112.00   0.00  25.63    0.00    3.00   0.68     0.00     5.38   3.06  99.60

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.00    0.00    0.25    1.51    0.00   98.24

Device            r/s     w/s     rkB/s     wkB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util
sdb              0.00  262.00      0.00   3424.00     0.00    86.00   0.00  24.71    0.00    3.79   0.80     0.00    13.07   3.83 100.40

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.00    0.00    0.25   12.56    0.00   87.19

Device            r/s     w/s     rkB/s     wkB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util
sdb              0.00  276.00      0.00   1472.00     0.00    92.00   0.00  25.00    0.00    3.59   0.78     0.00     5.33   3.64 100.40
</code></pre><p><code>/dev/sdb</code> ã«å¯¾ã—ã¦ã€Write å‘½ä»¤ãŒå¤šãè¦‹ã‚‰ã‚Œã‚‹ã€‚å…·ä½“çš„ã«ã¯ã€ä»¥ä¸‹ã®é€šã‚Š:</p><ul><li>ç§’ã‚ãŸã‚Šã® Read ãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†æ•° (r/s) ã¯ã‚¼ãƒ­</li><li>ç§’ã‚ãŸã‚Šã® Write ãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†æ•° (w/s) ã¯ 300 è¿‘ã„</li><li>ç§’ã‚ãŸã‚Šã® Read ã‚»ã‚¯ã‚¿é‡ (rkB/s) ã¯ã‚¼ãƒ­</li><li>ç§’ã‚ãŸã‚Šã® Write ã‚»ã‚¯ã‚¿é‡ (wkB/s) ã¯æ•°åƒ Kbyte è¿‘ã„</li></ul><p>ã¾ãŸã€Write å´ã®ã‚­ãƒ¥ãƒ¼ã‚µã‚¤ã‚º (wavgqu-sz) ãŒæ’å¸¸çš„ã« 1 ã‚’è¶…ãˆãŸå€¤ã‚’è¨˜éŒ²ã—ã¦ã„ã‚‹ã®ã§ã€ç‰©ç†ãƒ‡ãƒã‚¤ã‚¹ I/O ã®é£½å’ŒãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã“ã¨ãŒã€ã“ã“ã‹ã‚‰ã‚‚ã‚ã‹ã‚‹ã€‚</p><p>ãªãŠã€Write ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒãƒ¼ã‚¸ç‡ (%wrqm) ãŒ 25% ã¨æ¯”è¼ƒçš„é«˜ã„ã“ã¨ã‹ã‚‰ã€åŒã˜ã‚ˆã†ãªã‚»ã‚¯ã‚¿ã¸ã®æ›¸ãè¾¼ã¿ãŒå¤šãç™ºç”Ÿã—ã¦ã„ãã†ãªåŒ‚ã„ãŒã™ã‚‹ã€‚</p><pre tabindex=0><code>root@vm-ubuntu:~# free -m
              total        used        free      shared  buff/cache   available
Mem:          16013         295       14840           0         877       15431
Swap:             0           0           0
</code></pre><p>free + buff/cache ãªã„ã—ã¯ available ã«å…¨ç„¶ä½™è£•ãŒã‚ã‚‹ã®ã§ã€å•é¡Œãªã—ã€‚<code>dmseg</code> ã§ <code>oom-killer</code> ã‚‚è¦³æ¸¬ã—ã¦ã„ãªã„ã€‚</p><pre tabindex=0><code>root@vm-ubuntu:~# sar -n DEV 1
Linux 5.4.0-1047-azure (vm-ubuntu)      05/13/21        _x86_64_        (4 CPU)

13:04:38        IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s   %ifutil
13:04:39           lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
13:04:39         eth0      1.00      0.00      0.06      0.00      0.00      0.00      0.00      0.00

13:04:39        IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s   %ifutil
13:04:40           lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
13:04:40         eth0      1.00      2.00      0.06      1.49      0.00      0.00      0.00      0.00

13:04:40        IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s   %ifutil
13:04:41           lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
13:04:41         eth0      1.00      1.00      0.06      0.60      0.00      0.00      0.00      0.00
</code></pre><p>ä½¿ç”¨ç‡ (%ifutil) ã‚’è¦‹ã¦ã‚‚å…¨ç„¶ä½™è£•ãŒã‚ã‚‹ã—ã€å®Ÿéš›ç™ºç”Ÿã—ã¦ã„ã‚‹ãƒ‘ã‚±ãƒƒãƒˆã®æ•°ã‚„é‡ (*pck/s, *kB/s) ã‚‚å°‘ãªã„ã€‚</p><pre tabindex=0><code>root@vm-ubuntu:~# sar -n TCP,ETCP 1
Linux 5.4.0-1047-azure (vm-ubuntu)      05/13/21        _x86_64_        (4 CPU)

13:07:05     active/s passive/s    iseg/s    oseg/s
13:07:06         0.00      0.00      1.00      0.00

13:07:05     atmptf/s  estres/s retrans/s isegerr/s   orsts/s
13:07:06         0.00      0.00      0.00      0.00      0.00

13:07:06     active/s passive/s    iseg/s    oseg/s
13:07:07         0.00      0.00      1.00      2.00

13:07:06     atmptf/s  estres/s retrans/s isegerr/s   orsts/s
13:07:07         0.00      0.00      0.00      0.00      0.00

13:07:07     active/s passive/s    iseg/s    oseg/s
13:07:08         0.00      0.00      1.00      2.00

13:07:07     atmptf/s  estres/s retrans/s isegerr/s   orsts/s
13:07:08         0.00      0.00      0.00      0.00      0.00
</code></pre><p>å¿µã®ç‚ºã¿ã¦ã¿ãŸãŒã€TCP ãƒ¬ãƒ™ãƒ«ã® stats ã§ã‚‚å•é¡Œãªã„ã€‚</p><pre tabindex=0><code>root@vm-ubuntu:~# top

top - 13:08:08 up  1:07,  4 users,  load average: 2.05, 2.01, 1.90
Tasks: 157 total,   1 running,  89 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.2 us,  0.6 sy,  0.0 ni, 92.6 id,  6.5 wa,  0.0 hi,  0.2 si,  0.0 st
KiB Mem : 16398260 total, 15191744 free,   306500 used,   900016 buff/cache
KiB Swap:        0 total,        0 free,        0 used. 15798152 avail Mem

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
  380 root      20   0       0      0      0 D   1.3  0.0   0:33.53 jbd2/sdb1-8
 5689 root      20   0    6564   3016   1136 D   1.0  0.0   0:30.62 lab001
  418 root       0 -20       0      0      0 I   0.3  0.0   0:04.96 kworker/0:1H-kb
 8713 root      20   0   44560   3988   3344 R   0.3  0.0   0:00.05 top
    1 root      20   0   78000   9032   6572 S   0.0  0.1   0:02.95 systemd
</code></pre><p><code>D</code> (UNINTERRUPTIBLE_SLEEP) ãªãƒ—ãƒ­ã‚»ã‚¹ 2 ã¤ãŒ top ã®ä¸Šä½ã«ãã¦ã„ã‚‹ã®ã§ã€ã“ã„ã¤ã‚‰ãŒ I/O (write) ã‚’å é ˜ã—ã¦ã„ã‚‹ã¨è€ƒãˆã‚‹ã®ãŒå¦¥å½“ãã†ã€‚</p><h2 id=bcc-tools>bcc tools
<a class=heading-link href=#bcc-tools><i class="fa-solid fa-link" aria-hidden=true title=è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯></i>
<span class=sr-only>è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯</span></a></h2><p>ä¸Šè¨˜ã® 60 ç§’ (è‡ªåˆ†ãŒã‚„ã‚‹ã¨æ•°åˆ†ã‹ã‹ã‚‹) åˆ†æã«ã‚ˆã£ã¦ã€PID=5689 ã® <code>lab001</code> ãŒã€€I/O Write ã‚’å¤§é‡ã«ç™ºè¡Œã—ã¦ã„ã‚‹ãŸã‚ã«ã€ã‚·ã‚¹ãƒ†ãƒ ã«è² è·ãŒã‹ã‹ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã“ã¨ãŒã‚ã‹ã£ãŸã€‚
ç¶šã„ã¦ã€bcc ã®ä¸€èˆ¬çš„ãªãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ã€æ›´ã«è©³ç´°ã«åˆ†æã—ã¦ã„ãã“ã¨ã«ã™ã‚‹ã€‚</p><p><a href=https://github.com/iovisor/bcc/blob/master/docs/tutorial.md#1-general-performance class=external-link target=_blank rel=noopener>bcc/tutorial.md at master Â· iovisor/bcc</a></p><h3 id=execsnoop>execsnoop
<a class=heading-link href=#execsnoop><i class="fa-solid fa-link" aria-hidden=true title=è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯></i>
<span class=sr-only>è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯</span></a></h3><pre tabindex=0><code>root@vm-ubuntu:~/bcc/tools# ./execsnoop.py
PCOMM            PID    PPID   RET ARGS
pgrep            9213   2672     0 /usr/bin/pgrep -U omsagent omiagent
sh               9214   2672     0 /bin/sh -c /opt/omi/bin/omicli wql root/scx &#34;SELECT PercentUserTime, PercentPrivilegedTime, UsedMemory, PercentUsedMemory FROM SCX_UnixProc
omicli           9216   9214     0 /opt/omi/bin/omicli wql root/scx SELECT PercentUserTime, PercentPrivilegedTime, UsedMemory, PercentUsedMemory FROM SCX_UnixProcessStatisticalInformation where Ha
grep             9217   9214     0 /bin/grep =
sh               9219   2672     0 /bin/sh -c /opt/omi/bin/omicli wql root/scx &#34;SELECT PercentUserTime, PercentPrivilegedTime, UsedMemory, PercentUsedMemory FROM SCX_UnixProc
</code></pre><p>ç‰¹ã« 5689 ã‹ã‚‰ child process ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„ã€‚</p><h3 id=opensnoop>opensnoop
<a class=heading-link href=#opensnoop><i class="fa-solid fa-link" aria-hidden=true title=è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯></i>
<span class=sr-only>è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯</span></a></h3><pre tabindex=0><code>root@vm-ubuntu:~/bcc/tools# ./opensnoop.py -p $(pgrep -nx lab001)
PID    COMM               FD ERR PATH
</code></pre><p>æ–°ãŸã« file ã‚’ open ã—ã¦ã„ã‚‹è¨³ã§ã¯ãªã„</p><h3 id=ext4slower-or-btrfs-xfs-zfs>ext4slower (or btrfs*, xfs*, zfs*)
<a class=heading-link href=#ext4slower-or-btrfs-xfs-zfs><i class="fa-solid fa-link" aria-hidden=true title=è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯></i>
<span class=sr-only>è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯</span></a></h3><pre tabindex=0><code>root@vm-ubuntu:~/bcc/tools# ./ext4slower.py
Tracing ext4 operations slower than 10 ms
TIME     COMM           PID    T BYTES   OFF_KB   LAT(ms) FILENAME
13:22:38 lab001         5689   S 0       0          10.15 lab001.log
13:22:38 lab001         5689   S 0       0          11.70 lab001.log
13:22:39 lab001         5689   S 0       0          11.76 lab001.log
13:22:39 lab001         5689   S 0       0          10.42 lab001.log
13:22:39 lab001         5689   S 0       0          10.02 lab001.log
</code></pre><p>åŒã˜ path ã® file ã«å¯¾ã—ã¦ã€<code>S</code> ã®ç¨®åˆ¥ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¤šç™ºã—ã¦ã„ã‚‹ã€‚<code>ext4slower.py</code> ã®å®Ÿè£…ã‚’è¦‹ã‚‹ã¨ã€Type ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã€‚</p><ul><li><code>R</code>: read</li><li><code>W</code>: write</li><li><code>O</code>: open</li><li><code>S</code>: fsync</li></ul><p>ã¤ã¾ã‚Šã€1 ç§’é–“ã«æ•°å›ã®é«˜é »åº¦ã§ fsync ãŒå®Ÿæ–½ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚</p><h3 id=biolatency>biolatency
<a class=heading-link href=#biolatency><i class="fa-solid fa-link" aria-hidden=true title=è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯></i>
<span class=sr-only>è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯</span></a></h3><pre tabindex=0><code>root@vm-ubuntu:~/bcc/tools# ./biolatency.py -D -Q
Tracing block device I/O... Hit Ctrl-C to end.
^C

disk = b&#39;sdb&#39;
     usecs               : count     distribution
         0 -&gt; 1          : 0        |                                        |
         2 -&gt; 3          : 0        |                                        |
         4 -&gt; 7          : 0        |                                        |
         8 -&gt; 15         : 0        |                                        |
        16 -&gt; 31         : 0        |                                        |
        32 -&gt; 63         : 39       |****                                    |
        64 -&gt; 127        : 356      |****************************************|
       128 -&gt; 255        : 316      |***********************************     |
       256 -&gt; 511        : 169      |******************                      |
       512 -&gt; 1023       : 74       |********                                |
      1024 -&gt; 2047       : 16       |*                                       |
      2048 -&gt; 4095       : 4        |                                        |
      4096 -&gt; 8191       : 258      |****************************            |
      8192 -&gt; 16383      : 210      |***********************                 |
     16384 -&gt; 32767      : 12       |*                                       |
     32768 -&gt; 65535      : 1        |                                        |
</code></pre><p>Disk queue ã«å…¥ã£ã¦ã‹ã‚‰å®Œäº†ã™ã‚‹ã¾ã§ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼åˆ†å¸ƒã‚’è¡¨ç¤ºã€‚åˆ†å¸ƒãŒäºŒå³°ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ãŒé…ã„ã»ã†ã®åˆ†å¸ƒã¯ç‰¹å®šãƒ—ãƒ­ã‚°ãƒ©ãƒ  (i.e. lab001) ã«ã‚ˆã‚‹å½±éŸ¿ã¨ä»®è¨­ã§ãã‚‹ã€‚</p><h3 id=biosnoop>biosnoop
<a class=heading-link href=#biosnoop><i class="fa-solid fa-link" aria-hidden=true title=è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯></i>
<span class=sr-only>è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯</span></a></h3><pre tabindex=0><code>root@vm-ubuntu:~/bcc/tools# ./biosnoop.py
TIME(s)     COMM           PID    DISK    T SECTOR     BYTES  LAT(ms)
0.000000    jbd2/sdb1-8    380    sdb     W 2406576    4096      3.21
0.000348    lab001         5689   sdb     W 9009528    4096      0.21
0.000524    jbd2/sdb1-8    380    sdb     W 2406584    8192      0.14
0.004578    ?              0              R 0          0         4.00
0.007575    jbd2/sdb1-8    380    sdb     W 2406600    4096      2.96
0.007825    lab001         5689   sdb     W 9009528    4096      0.17
0.007917    jbd2/sdb1-8    380    sdb     W 2406608    8192      0.06
</code></pre><p>ã‚„ã¯ã‚Š lab001 ã«ã‚ˆã‚‹ Write ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šãç™ºç”Ÿã—ã¦ã„ã‚‹ã€‚ext4 ç”¨ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã§ã‚ã‚‹ <code>jdb2</code> ãŒé€£å‹•ã—ã¦ã„ã‚‹ã“ã¨ã€lab001 ãŒç™ºè¡Œã™ã‚‹ wirte ã®ã‚µã‚¤ã‚ºãŒ 4096 ã§ã‚ã‚‹ã“ã¨ã‚’è€ƒæ…®ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æ¨æ¸¬ã§ãã‚‹:</p><ul><li>lab001 ãŒé »ç¹ã«æ›¸ãè¾¼ã¿ã—ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã¯ ext4 ã§ã‚ã‚Šã€ãã® block size ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® 4096 byte ã§ã‚ã‚‹ã€‚</li></ul><p>ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«ç–ã„ã®ã§ã€ã¾ãŸåˆ¥ã®æ©Ÿä¼šã« ext4 ã¨ jdb2 ã«ã¤ã„ã¦èª¿ã¹ã¦ã¿ãŸã„ã€‚</p><h3 id=cachestat>cachestat
<a class=heading-link href=#cachestat><i class="fa-solid fa-link" aria-hidden=true title=è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯></i>
<span class=sr-only>è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯</span></a></h3><pre tabindex=0><code>root@vm-ubuntu:~/bcc/tools# ./cachestat.py
    HITS   MISSES  DIRTIES HITRATIO   BUFFERS_MB  CACHED_MB
       0        0      720    0.00%           93        782
     132        0      211  100.00%           93        782
       0        0      724    0.00%           93        782
     106        0      210  100.00%           93        782
       0        0      716    0.00%           93        782
     112        0      220  100.00%           93        782
       0        0      708    0.00%           93        782
</code></pre><p>ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã§ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡ã«ã¯å•é¡Œã¯ãªã—ã€‚</p><h3 id=tcpconnect>tcpconnect
<a class=heading-link href=#tcpconnect><i class="fa-solid fa-link" aria-hidden=true title=è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯></i>
<span class=sr-only>è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯</span></a></h3><pre tabindex=0><code>root@vm-ubuntu:~/bcc/tools# ./tcpconnect.py
Tracing connect ... Hit Ctrl-C to end
PID    COMM         IP SADDR            DADDR            DPORT
1628   python3      4  10.0.0.4         168.63.129.16    80
1628   python3      4  10.0.0.4         168.63.129.16    32526
1628   python3      4  10.0.0.4         168.63.129.16    80
1628   python3      4  10.0.0.4         169.254.169.254  80
1628   python3      4  10.0.0.4         168.63.129.16    80
</code></pre><p>Azure VM ã§ãƒ›ã‚¹ãƒˆã—ãŸ Ubuntu ãƒã‚·ãƒ³ã ã£ãŸã®ã§ã€ç®¡ç†ç”¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (waagent) ãŒä»®æƒ³ IP ã¨é€šä¿¡ã—ã¦ã„ã‚‹æ§˜å­ãŒè¦‹ãˆãŸã€‚ãã‚Œä»¥å¤–ã«æ€ªã—ã„ç‚¹ã¯ãªã—ã€‚</p><h3 id=tcpaccept>tcpaccept
<a class=heading-link href=#tcpaccept><i class="fa-solid fa-link" aria-hidden=true title=è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯></i>
<span class=sr-only>è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯</span></a></h3><pre tabindex=0><code>root@vm-ubuntu:~/bcc/tools# ./tcpaccept.py
PID     COMM         IP RADDR            RPORT LADDR            LPORT
</code></pre><p>passive TCP ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ (accept çµŒç”±ã® TCP ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ç¢ºç«‹) ã¯ç‰¹ã«ç™ºç”Ÿãªã—ã€‚</p><h3 id=tcpretrans>tcpretrans
<a class=heading-link href=#tcpretrans><i class="fa-solid fa-link" aria-hidden=true title=è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯></i>
<span class=sr-only>è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯</span></a></h3><pre tabindex=0><code>root@vm-ubuntu:~/bcc/tools# ./tcpretrans.py
Tracing retransmits ... Hit Ctrl-C to end
TIME     PID    IP LADDR:LPORT          T&gt; RADDR:RPORT          STATE
</code></pre><p>TCP ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã®å†é€ã‚‚ãªã—ã€‚</p><h3 id=runqlat>runqlat
<a class=heading-link href=#runqlat><i class="fa-solid fa-link" aria-hidden=true title=è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯></i>
<span class=sr-only>è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯</span></a></h3><pre tabindex=0><code>root@vm-ubuntu:~/bcc/tools# ./runqlat.py
Tracing run queue latency... Hit Ctrl-C to end.
^C
     usecs               : count     distribution
         0 -&gt; 1          : 200      |**                                      |
         2 -&gt; 3          : 779      |*********                               |
         4 -&gt; 7          : 1761     |********************                    |
         8 -&gt; 15         : 3433     |****************************************|
        16 -&gt; 31         : 1086     |************                            |
        32 -&gt; 63         : 91       |*                                       |
        64 -&gt; 127        : 649      |*******                                 |
       128 -&gt; 255        : 9        |                                        |
       256 -&gt; 511        : 3        |                                        |
       512 -&gt; 1023       : 3        |                                        |
      1024 -&gt; 2047       : 1        |                                        |
      2048 -&gt; 4095       : 1        |                                        |
</code></pre><p>ran queue ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã®åˆ†å¸ƒã‚’è¦‹ã¦ã‚‚ã€queue å†…ã§é•·ã„é–“å¾…ãŸã•ã‚Œã¦ã„ã‚‹ Task ã¯ã»ã¼ãªã„ã®ã§ã€CPU ã®é£½å’Œã¯èªã‚ã‚‰ã‚Œãªã„ã€‚</p><h2 id=ç­”ãˆåˆã‚ã›>ç­”ãˆåˆã‚ã›
<a class=heading-link href=#%e7%ad%94%e3%81%88%e5%90%88%e3%82%8f%e3%81%9b><i class="fa-solid fa-link" aria-hidden=true title=è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯></i>
<span class=sr-only>è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯</span></a></h2><p>å®Ÿè¡Œã—ã¦ã„ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ä¸‹è¨˜ã«å­˜åœ¨ã™ã‚‹ã€‚</p><p><a href=https://github.com/brendangregg/bpf-perf-workshop/blob/master/src/lab001.c class=external-link target=_blank rel=noopener>bpf-perf-workshop/lab001.c at master Â· brendangregg/bpf-perf-workshop</a></p><ul><li><code>fsync</code> ã‚’ä¼´ã† <code>write</code> (os_write é–¢æ•°) ã‚’æ°¸é ã«å›ã™ãƒ—ãƒ­ã‚°ãƒ©ãƒ </li><li>128 byte ã‚‚ã—ãã¯ 2 Mbyte ãšã¤ã€zero åŸ‹ã‚ã•ã‚ŒãŸé…åˆ—ã‚’ os_wirte ã§æ›¸ãè¾¼ã‚“ã§ã„ãã€‚</li><li>ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º (50 Mbyte) ã®æœ€å¾Œã¾ã§ zero é…åˆ—ã‚’æ›¸ãè¾¼ã‚“ã ã‚‰ã€<code>lseek</code> ã§ offset=0 ã«æˆ»ã£ã¦å†åº¦ã‚„ã‚Šç›´ã—ã€‚</li></ul><p>ã¨ã„ã†ã“ã¨ã§ã€<code>fsync</code> ã‚’ä¼´ã£ã¦ã„ã‚‹ãŸã‚ã«ã€128 byte ã®æ›¸ãè¾¼ã¿ã‚’è¡Œã†ã¨ãã¯ã€ext4 ã® block size ã§ã‚ã‚‹ 4096 byte ã«æ›¸ãè¾¼ã¿ãŒ expand ã•ã‚Œã‚‹ã€‚ãã®ãŸã‚ã€æ®†ã©ãŒç„¡é§„ãª I/O ã«ãªã£ã¦ã—ã¾ã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚ä»¥ä¸‹ã® <code>biosnoop.py</code> ã‹ã‚‰ã‚‚ã€4096 byte ã®ç‰©ç† I/O (FIleSytem -> Disk ã®è¦æ±‚) ãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚‹ã€‚</p><pre tabindex=0><code>root@vm-ubuntu:~/bcc/tools# ./biosnoop.py | grep lab001
TIME(s)     COMM           PID    DISK    T SECTOR     BYTES  LAT(ms)
...
2.197601    jbd2/sdb1-8    380    sdb     W 2384488    4096      3.45
2.197816    lab001         5689   sdb     W 8997120    4096      0.08
2.198063    jbd2/sdb1-8    380    sdb     W 2384496    8192      0.19
2.203421    ?              0              R 0          0         5.34
2.207513    jbd2/sdb1-8    380    sdb     W 2384512    4096      4.06
2.209320    lab001         5689   sdb     W 8997120    524288    0.47
2.209352    lab001         5689   sdb     W 8998144    524288    0.49
2.209510    lab001         5689   sdb     W 8999168    524288    0.64
2.209675    lab001         5689   sdb     W 9000192    524288    0.80
2.209854    lab001         5689   sdb     W 9001216    4096      0.97
2.209957    jbd2/sdb1-8    380    sdb     W 2384520    8192      0.06
2.229271    ?              0              R 0          0        19.30
2.232790    jbd2/sdb1-8    380    sdb     W 2384536    4096      3.48
2.233011    lab001         5689   sdb     W 9001216    4096      0.11
2.233180    jbd2/sdb1-8    380    sdb     W 2384544    8192      0.10
2.237200    ?              0              R 0          0         4.00
</code></pre><p>ãªãŠã€é€”ä¸­ã§ 524288 byte ã® write è¦æ±‚ 4 ã¤ç¶šãç®‡æ‰€ãŒã‚ã‚‹ãŒã€ã“ã‚ŒãŒ 2 Mbyte ã®æ›¸ãè¾¼ã¿ã«ç›¸å½“ã™ã‚‹ã€‚</p><p>ext4 ãŒç‰©ç† I/O ã‚’ 524,288 byte ã«ä¸¸ã‚ã“ã‚“ã§ã„ã‚‹ãŸã‚ã« 4 ã¤ã«åˆ†å‰²ã•ã‚Œã¦ã„ã‚‹ã¨æ¨æ¸¬ã§ãã‚‹ãŒã€ä»Šã®çŸ¥è­˜ã§ã¯ ext4 ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãŒç‰©ç† I/O ã‚’è¨ˆç®—ã™ã‚‹æ–¹æ³•ãŒã‚ã‹ã‚‰ã‚‰ãšã€ãªãœ 4 åˆ†å‰²ã•ã‚Œã¦ã„ã‚‹ã®ã‹ (128 blocks åˆ†ã§ç‰©ç† I/O ã‚’ç™ºè¡Œã—ã¦ã„ã‚‹ã®ã‹) ã‚ã‹ã‚‰ãªã‹ã£ãŸã€‚ã“ã‚Œã¯ä»Šå¾Œã®èª²é¡Œã¨ã—ãŸã„ã€‚</p><h3 id=å¯¾å¿œç­–-fsync-ã‚’ã‚„ã‚ã‚‹>å¯¾å¿œç­–: fsync ã‚’ã‚„ã‚ã‚‹
<a class=heading-link href=#%e5%af%be%e5%bf%9c%e7%ad%96-fsync-%e3%82%92%e3%82%84%e3%82%81%e3%82%8b><i class="fa-solid fa-link" aria-hidden=true title=è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯></i>
<span class=sr-only>è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯</span></a></h3><p>æœ€ã‚‚å˜ç´”ã‹ã¤åŠ¹æœã®é«˜ã„å¯¾å¿œæ–¹æ³•ã¯ <code>fsync</code> ã‚’ã‚„ã‚ã‚‹ã“ã¨ã ã‚ã†ã€‚ã¤ã¾ã‚Šã€<code>lab001.c</code> ã«ä¸‹è¨˜ã®å¤‰æ›´ã‚’åŠ ãˆã‚‹ã€‚</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#e06c75>- fsync(fd);
</span></span></span><span style=display:flex><span><span style=color:#e06c75></span><span style=color:#98c379;font-weight:700>+ //fsync(fd);
</span></span></span></code></pre></div><p>å†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦å¾—ã‚‰ã‚ŒãŸæ–°ãŸãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ä¸‹è¨˜ã®ã‚ˆã†ã« I/O ã®æ”¹å–„ãŒè¦‹ã‚‰ã‚ŒãŸã€‚
æ–‡ç« ã«ã™ã‚‹ã¨ã€ã€Œfile system ã® write buffer (ã‚­ãƒ£ãƒƒã‚·ãƒ¥) ã«ã‚ˆã£ã¦ã€ç‰©ç† I/O ã®ç™ºè¡Œæ•°ãŒæ¸›ã‚Šã€<code>lab001</code> ã‚„ ext4 ã‚¸ãƒ£ãƒ¼ãƒŠãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ãŒ I/O å¾…ã¡ã™ã‚‹ã“ã¨ãŒãªããªã£ãŸã€ã¨ã„ã†ã¨ã“ã‚ã§ã—ã‚‡ã†ã‹ã€‚</p><pre tabindex=0><code>root@vm-ubuntu:~/bcc/tools# uptime
 14:54:26 up  2:53,  5 users,  load average: 1.03, 1.23, 1.62

root@vm-ubuntu:~/bcc/tools# vmstat -S k 1
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 2  0      0 15414116 102080 949317    0    0    19   601  108  351  0  1 93  6  0
 1  0      0 15414108 102080 949317    0    0     0     0  100  261  2 23 75  0  0
 1  0      0 15414108 102080 949317    0    0     0     4  111  303  2 23 75  0  0
 1  0      0 15414108 102080 949317    0    0     0 96860   96  255  1 16 74 10  0
 1  0      0 15414206 102080 949317    0    0     0     0   54  243  2 24 75  0  0
 1  0      0 15414206 102080 949321    0    0     0     0   75  212  2 24 75  0  0
 1  0      0 15414206 102080 949321    0    0     0     0   68  175  1 24 75  0  0
 1  0      0 15414206 102080 949321    0    0     0     0   44  112  2 23 75  0  0
 1  0      0 15414206 102080 949321    0    0     0     4  219  462  2 24 74  0  0
 1  0      0 15414206 102080 949317    0    0     0     4  637 1297  2 24 74  0  0

root@vm-ubuntu:~/bcc/tools# iostat -xz 1
avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           2.26    0.00   23.06    0.00    0.00   74.69

Device            r/s     w/s     rkB/s     wkB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util
sdb              0.00    1.00      0.00      4.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     4.00   4.00   0.40
</code></pre><h3 id=ãã®ä»–ã®å¯¾å¿œç­–>ãã®ä»–ã®å¯¾å¿œç­–
<a class=heading-link href=#%e3%81%9d%e3%81%ae%e4%bb%96%e3%81%ae%e5%af%be%e5%bf%9c%e7%ad%96><i class="fa-solid fa-link" aria-hidden=true title=è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯></i>
<span class=sr-only>è¦‹å‡ºã—ã¸ã®ãƒªãƒ³ã‚¯</span></a></h3><p>ãŠãã‚‰ãä»–ã«åŠ¹æœã®ã‚ã‚‹å¯¾å¿œã¯ä»¥ä¸‹ã®é€šã‚Š (æœ€å¾Œã®æ–¹ã¯ã‚·ã‚¹ãƒ†ãƒ ãƒ¯ã‚¤ãƒ‰ãªå¤‰æ›´ãªã®ã§ã€å¤šåˆ†å®Ÿç¾å¯èƒ½æ€§ã¯ä½ãã†)ã€‚</p><ul><li>è«–ç† I/O (write) ã®æ›¸ãè¾¼ã¿ã‚µã‚¤ã‚ºã‚’ã€çµ±ä¸€ã—ã¦å¤§ããã™ã‚‹</li><li>åŒã˜ç®‡æ‰€ (è«–ç† offset) ã®æ›¸ãè¾¼ã¿ã‚’ç¹°ã‚Šè¿”ã™ã‚¹ãƒ¬ãƒƒãƒ‰ã«åˆ†å‰²ã™ã‚‹ (e.g. thread0 ã¯ offset = [0, 4096] ã‚’æ‹…å½“)</li><li>ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ  (ext4) ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚µã‚¤ã‚ºã‚’ã€è«–ç† I/O ã«ã‚ã‚ã›ã¦èª¿ç¯€ã™ã‚‹</li><li>ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã§ã‚¸ãƒ£ãƒ¼ãƒŠãƒªãƒ³ã‚°ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹</li></ul></div><footer></footer></article></section></div><footer class=footer><section class=container>Â©
2024 -
2025
Junya Yamaguchi (@openjny)
Â·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "0a99e4ebb1e342beb03db419a6eea4a6"}'></script></body></html>